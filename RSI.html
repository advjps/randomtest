<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binance Futures RSI Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: auto;
        }
        h1 {
            text-align: center;
            color: #00b894;
        }
        .controls, .info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .controls select, .controls button {
            background-color: #2d2d2d;
            color: #e0e0e0;
            border: 1px solid #444;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 14px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #333;
            padding: 10px;
            text-align: right;
        }
        th {
            background-color: #1e1e1e;
            color: #00b894;
        }
        td:first-child, th:first-child {
            text-align: left;
            font-weight: bold;
        }
        .rsi-oversold { background-color: rgba(46, 204, 113, 0.3); }
        .rsi-overbought { background-color: rgba(231, 76, 60, 0.3); }
        .loader {
            text-align: center;
            padding: 30px;
            font-size: 18px;
        }
        a {
            color: #00b894;
            text-decoration: none;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Binance Futures RSI Dashboard</h1>

        <div class="controls">
            <div>
                <label for="sort-by">Sort By: </label>
                <select id="sort-by">
                    <option value="rsi1m" selected>RSI 1 min Candles</option>
                    <option value="coinName">Coin Name</option>
                    <option value="price">Current Price</option>
                    <option value="volume">24h Volume</option>
                    <option value="change">24h Change</option>
                    <option value="rsi5m">RSI 5 min Candles</option>
                    <option value="rsi15m">RSI 15 min Candles</option>
                    <option value="rsi1d">RSI 1 day Candles</option>
                </select>
                <select id="sort-order">
                    <option value="desc" selected>Descending</option>
                    <option value="asc">Ascending</option>
                </select>
            </div>
            <div class="info">
                <span id="last-updated">Last Updated: N/A</span>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Coin Name</th>
                    <th>Current Price</th>
                    <th>24h Volume (USDT)</th>
                    <th>24h Change (%)</th>
                    <th>RSI 1 min Candles</th>
                    <th>RSI 5 min Candles</th>
                    <th>RSI 15 min Candles</th>
                    <th>RSI 1 day Candles</th>
                </tr>
            </thead>
            <tbody id="data-table-body">
                <tr>
                    <td colspan="8" class="loader">Loading market data...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        // --- CONFIGURATION ---
        const API_BASE = "https://fapi.binance.com";
        const MIN_VOLUME_USDT = 100_000_000;
        const RSI_PERIOD = 14;
        const RSI_UPPER = 65;
        const RSI_LOWER = 30;
        const REFRESH_INTERVAL_MS = 60000; // 60 seconds

        // --- PROXY CONFIGURATION (from your snippet) ---
        const USE_PROXY = true; // Set to true to enable the CORS proxy
        const PROXY = "https://cors.isomorphic-git.org/";

        let marketData = [];

        const sortBySelect = document.getElementById('sort-by');
        const sortOrderSelect = document.getElementById('sort-order');
        const tableBody = document.getElementById('data-table-body');
        const lastUpdatedEl = document.getElementById('last-updated');

        // --- API & CALCULATION FUNCTIONS ---

        // Simple fetch wrapper with proxy support
        async function apiFetch(endpoint, params) {
            let url = API_BASE + endpoint;
            if (params) {
                const searchParams = new URLSearchParams(params).toString();
                url += `?${searchParams}`;
            }

            const finalUrl = USE_PROXY ? PROXY + url : url;
            
            const response = await fetch(finalUrl);
            if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
            return response.json();
        }
        
        // Custom RMA-based RSI calculation to match TradingView/Binance
        function calculateRSI(closes) {
            if (closes.length <= RSI_PERIOD) return null;
            let gains = 0;
            let losses = 0;

            for (let i = 1; i <= RSI_PERIOD; i++) {
                const diff = closes[i] - closes[i - 1];
                if (diff > 0) gains += diff;
                else losses -= diff;
            }

            let avgGain = gains / RSI_PERIOD;
            let avgLoss = losses / RSI_PERIOD;

            for (let i = RSI_PERIOD + 1; i < closes.length; i++) {
                const diff = closes[i] - closes[i - 1];
                let gain = (diff > 0) ? diff : 0;
                let loss = (diff < 0) ? -diff : 0;
                
                avgGain = (avgGain * (RSI_PERIOD - 1) + gain) / RSI_PERIOD;
                avgLoss = (avgLoss * (RSI_PERIOD - 1) + loss) / RSI_PERIOD;
            }

            if (avgLoss === 0) return 100;
            const rs = avgGain / avgLoss;
            return 100 - (100 / (1 + rs));
        }

        async function fetchRSI(symbol, interval) {
            const klines = await apiFetch('/fapi/v1/klines', { symbol, interval, limit: 100 });
            const closes = klines.map(k => parseFloat(k[4])); // Index 4 is the close price
            const rsi = calculateRSI(closes);
            return { rsi };
        }

        // --- UI & RENDERING FUNCTIONS ---
        function renderTable() {
            if (marketData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" class="loader">No coins currently meet the criteria.</td></tr>`;
                return;
            }

            const sortBy = sortBySelect.value;
            const sortOrder = sortOrderSelect.value;

            const sortedData = [...marketData].sort((a, b) => {
                let valA = a[sortBy];
                let valB = b[sortBy];

                if (typeof valA === 'string') {
                    return sortOrder === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                } else {
                    return sortOrder === 'asc' ? valA - valB : valB - valA;
                }
            });

            tableBody.innerHTML = '';
            sortedData.forEach(coin => {
                const row = document.createElement('tr');
                const rsiClass = coin.rsi1m >= RSI_UPPER ? 'rsi-overbought' : (coin.rsi1m <= RSI_LOWER ? 'rsi-oversold' : '');
                
                const formatVolume = (vol) => {
                    if (vol >= 1_000_000_000) return `${(vol / 1_000_000_000).toFixed(2)}B`;
                    if (vol >= 1_000_000) return `${(vol / 1_000_000).toFixed(2)}M`;
                    return vol.toLocaleString();
                };

                row.innerHTML = `
                    <td><a href="https://www.binance.com/en/futures/${coin.coinName}" target="_blank">${coin.coinName}</a></td>
                    <td>${coin.price.toFixed(4)}</td>
                    <td>${formatVolume(coin.volume)}</td>
                    <td>${coin.change.toFixed(2)}%</td>
                    <td class="${rsiClass}">${coin.rsi1m.toFixed(2)}</td>
                    <td>${coin.rsi5m ? coin.rsi5m.toFixed(2) : 'N/A'}</td>
                    <td>${coin.rsi15m ? coin.rsi15m.toFixed(2) : 'N/A'}</td>
                    <td>${coin.rsi1d ? coin.rsi1d.toFixed(2) : 'N/A'}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // --- MAIN APPLICATION LOGIC ---
        async function updateDashboard() {
            try {
                const allTickers = await apiFetch('/fapi/v1/ticker/24hr');
                const highVolumeTickers = allTickers.filter(t => parseFloat(t.quoteVolume) >= MIN_VOLUME_USDT && t.symbol.endsWith('USDT'));
                
                console.log(`Found ${highVolumeTickers.length} high-volume markets. Scanning...`);
                
                let freshData = [];
                for (const ticker of highVolumeTickers) {
                    const { rsi: rsi1m } = await fetchRSI(ticker.symbol, '1m');
                    
                    if (rsi1m !== null && (rsi1m >= RSI_UPPER || rsi1m <= RSI_LOWER)) {
                        console.log(`HIT: ${ticker.symbol} with 1-min RSI of ${rsi1m.toFixed(2)}. Fetching other timeframes...`);
                        
                        const [{rsi: rsi5m}, {rsi: rsi15m}, {rsi: rsi1d}] = await Promise.all([
                            fetchRSI(ticker.symbol, '5m'),
                            fetchRSI(ticker.symbol, '15m'),
                            fetchRSI(ticker.symbol, '1d')
                        ]);

                        freshData.push({
                            coinName: ticker.symbol,
                            price: parseFloat(ticker.lastPrice),
                            volume: parseFloat(ticker.quoteVolume),
                            change: parseFloat(ticker.priceChangePercent),
                            rsi1m: rsi1m,
                            rsi5m: rsi5m,
                            rsi15m: rsi15m,
                            rsi1d: rsi1d
                        });
                    }
                }
                marketData = freshData;
                renderTable();

            } catch (error) {
                console.error("Failed to update dashboard:", error);
                tableBody.innerHTML = `<tr><td colspan="8" class="loader">Error fetching data. Check browser console for details.</td></tr>`;
            } finally {
                lastUpdatedEl.textContent = `Last Updated: ${new Date().toLocaleTimeString()}`;
            }
        }

        // --- INITIALIZATION ---
        sortBySelect.addEventListener('change', renderTable);
        sortOrderSelect.addEventListener('change', renderTable);
        
        updateDashboard();
        setInterval(updateDashboard, REFRESH_INTERVAL_MS);

    </script>

</body>
</html>
